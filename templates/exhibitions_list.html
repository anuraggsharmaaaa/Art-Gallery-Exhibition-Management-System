{% extends "base.html" %}

{% block title %}Exhibitions - Art Gallery{% endblock %}

{% block content %}
    <h1 class="page-title">Exhibitions at {{ gallery_name }}</h1>

    <div class="card-grid">
        {% for ex in exhibitions %}
        <div class="card" style="animation-delay: {{ loop.index * 0.1 }}s;">
            {% if ex.EndDate and today %}
                {% set days_left = (ex.EndDate - today).days %}
                {% if days_left >= 0 and days_left <= 30 %}
                    <span class="leaving-soon-badge" style="position: absolute; top: 15px; right: -10px; background: #ff9500; color: #000; padding: 5px 10px; font-family: -apple-system, sans-serif; font-size: 0.8rem; font-weight: 700; border-radius: 3px;">LEAVING SOON ({{ days_left }} days)</span>
                {% endif %}
            {% endif %}

            <div class="image-placeholder"></div>
            <div class="info">
                <h3>{{ ex.Title }}</h3>
                <p class="dates">{{ ex.StartDate.strftime('%B %d, %Y') }} â€” {{ ex.EndDate.strftime('%B %d, %Y') }}</p>
                <p>{{ ex.Description }}</p>
                <div class="button-group">
                    <a href="/exhibition/{{ ex.ExhibitionID }}" class="button">View Artworks</a>
                    <a href="#" class="button exhibit" 
                       data-exid="{{ ex.ExhibitionID }}"
                       data-title="{{ ex.Title | escape }}"
                       data-galleryid="{{ gallery_id }}"
                       data-startdate="{{ ex.StartDate.strftime('%Y-%m-%d') }}"
                       data-enddate="{{ ex.EndDate.strftime('%Y-%m-%d') }}"
                       onclick="showTicketModal(this); return false;">Buy Ticket ($25.00)</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div id="payment-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Buy Ticket</h2>
            <p>You are about to purchase a ticket for: <b id="modal-ex-title">Exhibition Title</b></p>
            <p>Price: <b>$25.00</b></p>
            <form id="payment-form">
                <div class="form-group">
                    <label for="visit_date">Visit Date</label>
                    <input type="date" id="visit_date" name="visit_date" required>
                </div>
                <h3>Select Payment Method</h3>
                <div><input type="radio" id="pay-cc" name="payment_method" value="Credit Card" checked><label for="pay-cc">Credit Card</label></div>
                <div><input type="radio" id="pay-upi" name="payment_method" value="UPI"><label for="pay-upi">UPI</label></div>
                <div><input type="radio" id="pay-net" name="payment_method" value="Net Banking"><label for="pay-net">Net Banking</label></div>
                <div class="modal-buttons">
                    <button type="button" id="cancel-payment-btn" onclick="hideModal('payment-modal')">Cancel</button>
                    <button type="button" id="confirm-payment-btn" onclick="confirmPayment()">Confirm Payment</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="success-overlay" class="modal-overlay">
        <div id="success-box">
            <div class="success-checkmark">&#x2713;</div>
            <h2 class.success-title">Payment Successful!</h2>
            <p class="success-message">Your ticket has been confirmed.</p>
            <a href="/profile" class="receipt-button">View in My Profile</a>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    let currentExhibitionID = null;
    let currentGalleryID = null;
    const modal = document.getElementById('payment-modal');
    const successOverlay = document.getElementById('success-overlay');
    const visitDateEl = document.getElementById('visit_date');
    const today = new Date().toISOString().split("T")[0];

    function showModal(id) {
        document.getElementById(id).classList.add('show');
    }
    function hideModal(id) {
        document.getElementById(id).classList.remove('show');
    }

    // *** THIS IS THE FIXED JAVASCRIPT ***
    function showTicketModal(button) {
        event.preventDefault(); // Stop the '#' link from jumping
        currentExhibitionID = button.dataset.exid;
        currentGalleryID = button.dataset.galleryid;
        document.getElementById('modal-ex-title').innerText = button.dataset.title;
        
        // --- This is your new "Date Constraint" feature ---
        const startDate = button.dataset.startdate;
        const endDate = button.dataset.enddate;

        // Set min date: either today or the start date, whichever is LATER
        visitDateEl.min = (startDate > today) ? startDate : today;
        // Set max date: the end date
        visitDateEl.max = endDate;
        // Set the default value to the first available day
        visitDateEl.value = visitDateEl.min;
        
        showModal('payment-modal');
    }

    async function confirmPayment() {
        const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;
        const visitDate = visitDateEl.value;
        
        // --- Check if date is in range ---
        if (!visitDate) {
            alert("Please select a visit date.");
            return;
        }
        if (visitDate < visitDateEl.min || visitDate > visitDateEl.max) {
            alert("Error: The selected date is not within the exhibition's valid range.");
            return;
        }

        const response = await fetch('/buy_ticket', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                exhibition_id: currentExhibitionID,
                gallery_id: currentGalleryID,
                visit_date: visitDate,
                payment_method: paymentMethod 
            })
        });
        const data = await response.json();
        
        hideModal('payment-modal');
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            showModal('success-overlay');
        }
    }
</script>
{% endblock %}